(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-48d74ea2"],{"3bbc":function(t,e,n){"use strict";n.r(e);var i=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"content",staticStyle:{height:"100%",overflow:"hidden"},attrs:{type:"flex"}},[n("div",{staticClass:"content-left",style:{width:"calc(100% - "+(t.showRight?"320px":"0px")+")"}},[n("div",{attrs:{id:"xterm"}}),n("div",{staticClass:"xterm_bottom"},[n("div",{on:{click:function(e){return t.$refs.ControlFontSize.show()}}},[n("a-icon",{attrs:{type:"font-size"}}),t._v(" 字体大小")],1),n("div",{on:{click:t.handleScreenFull}},[n("a-icon",{attrs:{type:"fullscreen"}}),t._v(" 全屏")],1),n("div",{on:{click:t.handleShowRight}},[n("a-icon",{attrs:{type:t.showRight?"eye":"eye-invisible"}}),t._v(" 会话详情")],1)]),n("uploadModal",{ref:"uploadModal",on:{done:t.getUploadFileList}}),n("ControlFontSize",{ref:"ControlFontSize",on:{setFontSize:t.setFontSize}})],1),n("div",{staticClass:"content-right",staticStyle:{height:"100%"},style:{width:t.showRight?"320px":"0px"}},[n("div",{staticClass:"rightbox"},[n("a-tabs",{on:{change:t.changeTabs},model:{value:t.tabs_key,callback:function(e){t.tabs_key=e},expression:"tabs_key"}},[n("a-tab-pane",{key:"1",staticClass:"session_info",attrs:{tab:"会话详情"}},[n("a-spin",{attrs:{spinning:t.xtemLoading}},[n("div",{staticStyle:{height:"100%"}},[n("div",[n("div",{staticClass:"term_info_box"},[n("div",{staticClass:"term_title"},[t._v("主机信息")]),n("div",{staticClass:"term_info"},[t._v("主机名称："+t._s(t.nodeInfo.host_name||"-"))]),n("div",{staticClass:"term_info"},[t._v("IP地址："+t._s(t.nodeInfo.host_address||"-"))])])])])])],1),"host"==t.linkType?n("a-tab-pane",{key:"2",staticClass:"file_trans",attrs:{tab:"文件传输",disabled:!t.file_manager}},[n("a-spin",{attrs:{spinning:t.fileLoading}},[n("div",{staticStyle:{height:"100%",overflow:"hidden"}},[n("div",{staticClass:"top_btns"},t._l(t.btnList,(function(e){return n("a-tooltip",{key:e.key,attrs:{placement:"top"}},[n("template",{slot:"title"},[n("span",[t._v(t._s(e.disabled?e.disabledHelp:e.text))])]),"upload"!=e.icon?n("a-button",{attrs:{icon:e.icon,type:"link",disabled:e.disabled},on:{click:function(n){return t.clickBtnChild(e)}}}):n("a-upload",{attrs:{name:"file",multiple:!1,showUploadList:!1,withCredentials:!0,customRequest:t.handleUpload,disabled:t.uploadLoading}},[n("a-button",{attrs:{icon:e.icon,type:"link",disabled:e.disabled},on:{click:function(n){return t.clickBtnChild(e)}}})],1)],2)})),1),n("div",{staticClass:"bread_box"},[n("a-breadcrumb",{staticClass:"breadcrumb_box"},t._l(t.breadCrumbList,(function(e,i){return n("a-breadcrumb-item",{key:i,staticClass:"breadcrumb",style:t.breadcrumbStyle,attrs:{title:e.name},nativeOn:{click:function(n){return t.clickBread(e,i)}}},[t._v(" "+t._s(e.name)+" ")])})),1)],1),t.tableData.length?n("div",{staticClass:"file_box"},t._l(t.tableData,(function(e,i){return n("div",{key:i,class:{isCheck:e.isCheck}},[n("span",{attrs:{title:e.name},on:{click:function(n){return t.clickFileName(e)}}},[n("a-icon",{staticStyle:{"padding-right":"2px"},attrs:{type:e.type}}),n("a-tooltip",{attrs:{placement:"topLeft",mouseLeaveDelay:.05}},[n("template",{slot:"title"},[n("span",[t._v(t._s(e.name))])]),n("span",[t._v(t._s(e.name))])],2)],1),n("a-tooltip",{attrs:{placement:"top"}},[n("template",{slot:"title"},[n("span",[t._v("删除")])]),n("a-icon",{staticClass:"del_icon",attrs:{type:"delete"},on:{click:function(n){return t.rightDelFile(e)}}})],2)],1)})),0):n("a-empty",{staticStyle:{"margin-top":"200px"}})],1)])],1):t._e()],1),t.showRight?n("div",{staticClass:"term_info_buttonbox"},[1==t.tabs_key?n("a-button",{staticClass:"term_info_button",attrs:{type:"primary"},on:{click:t.closeRemote}},[t._v("关闭/结束会话")]):t._e()],1):t._e()],1)])])},o=[],a=(n("99af"),n("7db0"),n("4160"),n("caad"),n("c975"),n("a15b"),n("fb6a"),n("a434"),n("ace4"),n("b0c0"),n("d3b7"),n("ac1f"),n("5319"),n("1276"),n("5cc6"),n("9a8c"),n("a975"),n("735e"),n("c1ac"),n("d139"),n("3a7b"),n("d5d6"),n("82f8"),n("e91f"),n("60bd"),n("5f96"),n("3280"),n("3fcc"),n("ca91"),n("25a1"),n("cd26"),n("3c5d"),n("2954"),n("649e"),n("219c"),n("170b"),n("b39a"),n("72f7"),n("159b"),n("53ca")),s=(n("96cf"),n("1da1")),r=n("fcf3"),c=n("47d0"),l=(n("abb2"),n("7c1c"),n("b123")),d=n.n(l),u=n("971f"),f=n("93bf"),h=n.n(f),p=n("f12c"),m=n("4cc6"),b=n("ca00"),_=n("e6c6"),g=n("f07a");d.a.Browser.send_files=u["a"];var k={components:{uploadModal:p["a"],ControlFontSize:m["a"]},data:function(){return{host_token:void 0,term:{},socket:null,fitAddon:null,zsentry:null,timer:null,nodeInfo:{},xtemLoading:!1,fileLoading:!1,url:"",urlParams:{},tabs_key:"1",tableData:[],current_path:"",breadCrumbList:[],uploadLoading:!1,copy_tool:!1,file_download:!1,file_upload:!1,file_manager:!1,showRight:!0,fontSize:14,linkType:"host"}},methods:{getAgentInfo:function(){var t=this,e=document.getElementById("xterm"),n=parseInt(e.clientHeight/17),i=parseInt((e.clientWidth-20)/9),o="http:"==window.location.protocol?"ws":"wss",a=!1,s={token:this.host_token,width:i,height:n},r="dataBase"==this.linkType?"databases":"terminalchannel";this.url=a?"wss://dev.opsany.cn/ws/bastion/".concat(r,"/").concat(Object(b["b"])(s)):"".concat(o,"://").concat(window.location.host,"/ws/bastion/").concat(r,"/").concat(Object(b["b"])(s)),this.xtemLoading=!0,Object(_["a"])({token:this.host_token,data_type:"host"}).then((function(e){t.nodeInfo=e.data})).finally((function(){t.xtemLoading=!1,t.initSocket()})),Object(_["a"])({token:this.host_token,data_type:"file_admin"}).then((function(e){t.copy_tool=e.data.copy_tool,t.file_download=e.data.file_download,t.file_manager=e.data.file_manager,t.file_upload=e.data.file_upload})).finally((function(){}))},changeTabs:function(t){2==t&&this.getLinuxFileInfo()},getLinuxFileInfo:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.current_path;this.fileLoading=!0;var n={data_type:"file_list",token:this.host_token,url:e};Object(g["c"])(n).then((function(e){t.current_path=e.data.current_path,t.handleBreadCrumb();var n=[],i=[];e.data.data.file.forEach((function(t){n.push({name:t,type:"file",isCheck:!1})})),e.data.data.path.forEach((function(t){i.push({name:t,type:"folder",isCheck:!1})})),t.tableData=i.concat(n)})).finally((function(){t.fileLoading=!1}))},clickBtnChild:function(t){this[t.key]&&this[t.key]()},refresh:function(){this.getLinuxFileInfo()},rightdownLoadFile:function(){var t=this.tableData.find((function(t){return t.isCheck}));if(!t)return this.$message.warning("请选择一个文件后下载");var e=this.current_path+"/"+t.name,n={token:this.host_token,url:e,data_type:"file"};window.open(Object(g["b"])(n))},handleUpload:function(t){var e=this;this.uploadLoading=!0;var n=this.$message.loading("文件上传中...",0),i=new FormData;i.append(t.filename,t.file),i.append("token",this.host_token),i.append("url",this.current_path),Object(g["d"])(i).then((function(t){e.$message.success(t.message),e.getLinuxFileInfo()})).finally((function(){n(),e.uploadLoading=!1}))},rightDelFile:function(t){var e=this,n=this.current_path+"/"+t.name,i={token:this.host_token,url:n};this.$confirm({title:"删除确认",content:"请确认是否删除【".concat(t.name,"】").concat("file"==t.type?"文件":"folder"==t.type?"文件夹":"","?"),okType:"danger",onOk:function(){return Object(g["a"])(i).then((function(t){e.$message.success(t.message),e.getLinuxFileInfo()}))}})},handleBreadCrumb:function(){var t=this.current_path.slice(1).split("/"),e=[];t.forEach((function(n,i){var o={name:n,path:t.slice(0,i+1).join("/")};e.push(o)})),e.length>3&&e.splice(1,e.length-3,{name:"...",path:null}),this.breadCrumbList=e},clickFileName:function(t){var e=this.current_path+"/"+t.name;"folder"==t.type?this.getLinuxFileInfo(e):(this.tableData.forEach((function(t){t.isCheck=!1})),t.isCheck=!0)},clickBread:function(t,e){t.path&&e!=this.breadCrumbList.length-1&&this.getLinuxFileInfo(t.path)},initXterm:function(){var t=this,e=new r["Terminal"]({rendererType:"canvas",rows:30,convertEol:!0,scrollback:1500,disableStdin:!1,cursorStyle:"underline",cursorBlink:!0,theme:{background:"#060101"},fontSize:this.fontSize});this.term=e,this.$nextTick((function(){var e=document.getElementById("xterm");if(e){t.term.open(e);var n=parseInt(e.clientHeight/17),i=parseInt((e.clientWidth-20)/9);t.fitAddon=new c["FitAddon"],t.initZmodem(),t.term.loadAddon(t.fitAddon),t.term.onData((function(e){var n=JSON.stringify(e);t.socket.onsend(n)})),t.send(JSON.stringify(["set_size",n,i,i,n])),t.fitAddon.fit(),t.term.onResize((function(e){var n=e.rows,i=e.cols;t.send(JSON.stringify(["set_size",n,i,i,n]))}))}}))},initZmodem:function(){var t=this;this.zsentry&&(this.zsentry=null),this.zsentry=new d.a.Sentry({to_terminal:function(t){},on_retract:function(t){},sender:function(e){t.send(new Uint8Array(e))},on_detect:function(e){var n=e.confirm();"receive"===n.type?t.downloadFile(n):t.uploadFile(n)}})},initSocket:function(){var t=this;return Object(s["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:t.socket=new WebSocket(t.url),t.socket.onopen=t.open,t.socket.onerror=t.error,t.socket.onmessage=t.getMessage,t.socket.onsend=t.send,t.socket.onclose=t.close,t.socket.binaryType="arraybuffer";case 7:case"end":return e.stop()}}),e)})))()},updateProgress:function(t){var e,n,i=t.get_details(),o=i.name,a=i.size;n=0===a?100:Math.round(t._file_offset/a*100),null===(e=this.term)||void 0===e||e.write("\r"+o+": "+a+" "+t._file_offset+" "+n+"%    ")},getUploadFileList:function(t,e){var n=this;d.a.Browser.send_files(t,e,{on_offer_response:function(t,e){var i;!e&&(null===(i=n.term)||void 0===i||i.write(t.name+" was upload skipped\r\n"))},on_progress:function(t,e){n.updateProgress(e)},on_file_complete:function(t){var e;null===(e=n.term)||void 0===e||e.write("\r\n")}}).then((function(e){t._last_header_name="ZRINIT",t.close()})).catch((function(t){}))},saveFile:function(t,e){return d.a.Browser.save_to_disk(t,e.get_details().name)},uploadFile:function(t){this.$refs.uploadModal.show(t)},downloadFile:function(t){var e=this;t.on("offer",(function(t){var n=[];t.on("input",(function(i){e.updateProgress(t),n.push(new Uint8Array(i))})),t.accept().then((function(){var i;e.saveFile(n,t),null===(i=e.term)||void 0===i||i.write("\r\n"),e.send(JSON.stringify('echo -en "OO"')),setTimeout((function(){e.initZmodem()}),1e3)}))})),t.on("session_end",(function(t){})),t.start()},setFontSize:function(t){this.term.setOption("fontSize",t),this.resizeTerm()},handleScreenFull:function(){var t=document.getElementById("xterm");this.$nextTick((function(){h.a.toggle(t)}))},handleShowRight:function(){this.showRight=!this.showRight,this.resizeTerm()},open:function(){this.closed=!1,this.initXterm()},error:function(){},getMessage:function(t){var e=this.$createElement;if("object"==Object(a["a"])(t.data))this.zsentry.consume(t.data);else{var n,i=[{key:1,errorMsg:"参数错误，请退出后重新连接。"},{key:2,errorMsg:"用户认证失败，请退出后重新连接。"},{key:3,errorMsg:"权限认证未通过，请联系管理员后重试。"},{key:4,errorMsg:"主机资源类型错误，请联系管理员。"},{key:5,errorMsg:"连接超时，请退出后重新连接。"},{key:6,errorMsg:"凭证验证失败，请联系管理员。"},{key:7,errorMsg:"创建连接失败，请退出后重新连接。"},{key:8,errorMsg:"目前不支持该类型数据库。"},{key:9,errorMsg:"无法连接到代理服务器。"}];if(t.data.indexOf("ws_errcode")>-1){var o,s=t.data.replace(/ws_errcode:/,""),r=i.find((function(t){return t.key==s}))||{},c=r.errorMsg||"连接失败,请联系管理员后重试";return null===(o=this.term)||void 0===o||o.write(c),this.$notification.open({message:"提示",description:" IP『 ".concat(this.nodeInfo.host_address," 』").concat(c),icon:e("a-icon",{attrs:{type:"frown"},style:"color: #FF4D4F"})})}null===(n=this.term)||void 0===n||n.write(t.data)}},send:function(t){var e;null===(e=this.socket)||void 0===e||e.send(t)},close:function(t){this.closed=!0},closeRemote:function(){window.close()},resizeTerm:function(){var t=this,e=document.getElementById("xterm");this.$nextTick((function(){!t.closed&&e&&t.fitAddon.fit()}))},debounce:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;return this.timer=null,function(){e.timer&&clearTimeout(e.timer),e.timer=setTimeout(t,n)}}},mounted:function(){var t=this;this.host_token=this.$route.query.host_token;var e=this.$route.query.linkType||"",n=["host","dataBase"];this.linkType=n.includes(e)?e:n[0],this.getAgentInfo();var i=this.debounce(this.resizeTerm,100);window.addEventListener("resize",i),this.$once("hook:beforeDestroy",(function(){window.removeEventListener("resize",i),t.timer&&clearTimeout(t.timer)}));var o=this.$route.query.fontSize;isNaN(o)?this.fontSize=14:this.fontSize=o-0>20||o-0<14?14:o-0},beforeDestroy:function(){this.socket.onsend(JSON.stringify(["close"])),this.socket.close()},beforeRouteLeave:function(){this.socket.onsend(JSON.stringify(["close"])),this.socket.close()},computed:{btnList:function(){return[{icon:"upload",key:"upload",text:"上传",disabled:!this.file_upload,disabledHelp:"因权限策略问题，暂时无法上传文件"},{icon:"download",key:"rightdownLoadFile",text:"下载",disabledHelp:"因权限策略问题或未选中文件，暂时无法下载文件",disabled:!this.tableData.find((function(t){return t.isCheck}))||!this.file_download},{icon:"reload",key:"refresh",text:"刷新",disabled:!this.file_manager,disabledHelp:"因权限策略问题，暂时无法查看文件"}]},breadcrumbStyle:function(){var t=this.breadCrumbList.length;return{maxWidth:1==t?"100%":2==t?"50%":3==t?"33%":"28%"}}}},y=k,v=(n("668f"),n("2877")),w=Object(v["a"])(y,i,o,!1,null,"92477bea",null);e["default"]=w.exports},4625:function(t,e,n){},"668f":function(t,e,n){"use strict";var i=n("4625"),o=n.n(i);o.a}}]);